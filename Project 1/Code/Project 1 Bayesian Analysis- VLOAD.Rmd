---
title: 'Project 1 Bayesian Analysis: VLOAD'
author: "Rachel Austin"
date: "2026-02-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(cmdstanr)
library(bayesplot)  # diagnostic plots of the MCMC chains
library(posterior)  # for summarizing posterior draws
library(bayestestR) # for calculating higest density posterior intervals
library(mcmcse)     # for calculating MCMCSE's
library(loo)        # for getting model fit statistics (WAIC and LOO-IC)
library(dplyr)
library(tibble)
```

Bayesian Analysis
```{r}
mod <- cmdstan_model("/Users/austinra/BIOS6624/Project 1/Code/STAN/linear_regression_half_normal.stan")
df <- read.xlsx("/Users/austinra/BIOS6624/Project 1/Data Processed/Analysis Dataset.xlsx")

#Change factor variables
df <- df %>% 
  mutate(newid = as.character(newid),
         hard_drugs = factor(hard_drugs),
         smoke = factor(smoke),
         education = factor(education),
         race = factor(race),
         adh_2 = factor(adh_2))
```

Following code pulled from https://github.com/camillemmoore/BIOS6624/blob/main/PSAExample/Code/2_PrelimModels_Gleason_Worksheet3.R


Parameters
```{r}
y.VLOAD <- df$log_vload_2 
X.VLOAD <- model.matrix(~ log_vload_0 + hard_drugs + age + BMI + smoke + race + education, data = df)
N.VLOAD <- nrow(df)
P.VLOAD <- 8

m <-c(rep(0, P.VLOAD))
s <- rep(1000, P.VLOAD)
sigma_sd <- 1000
```

Create data list to pass to STAN
```{r}
data_list_VLOAD <- list(
  N = N.VLOAD,
  P = P.VLOAD,
  X = X.VLOAD,
  y = y.VLOAD,
  prior_mean = m,
  prior_sd = s,
  sigma_prior_sd = sigma_sd
)
```

#Fit the model
```{r}
fit.VLOAD <- mod$sample(
  data = data_list_VLOAD,
  chains = 4,
  iter_warmup = 2000,
  iter_sampling = 10000,
  seed = 14
)
```

#Summarize the posterior
```{r}
fit.VLOAD$summary(variables=c("beta[1]", "beta[2]","beta[3]", "beta[4]", "beta[5]", "beta[6]", "beta[7]", "beta[8]", "sigma"))
```


# Fancier Table of Results of Interest from the Posterior
# Extracting posterior draws from cmdstanr fit
```{r}
draws.VLOAD <- fit$draws()  

draws_mat_VLOAD <- as_draws_matrix(draws.VLOAD)
params_VLOAD <- colnames(draws_mat_VLOAD)

# Exclude non-parameter columns from summarization: lp__ and log_lik[n]
params_VLOAD <- params_VLOAD[!grepl("lp__|log_lik", params_VLOAD)]


# Build summary table
summary_table_VLOAD <- lapply(params_VLOAD, function(p) {
  vals_VLOAD <- as.numeric(draws_mat_VLOAD[, p])
  
  # Monte Carlo standard error
  # Used to determine if we have run enough iterations
  # rule of thumb: MCSE should be less than 6.27% of the posterior standard deviation
  mcse_val_VLOAD <- mcmcse::mcse(vals_VLOAD)$se
  
  # Effective sample size
  ess_val_VLOAD <- ess_bulk(vals_VLOAD)
  
  # 95% HPDI
  hpd_VLOAD <- hdi(vals_VLOAD, ci = 0.95)
  
  tibble(
    Parameter = p,
    Estimate  = mean(vals_VLOAD),
    MCSE      = mcse_val_VLOAD,
    Std_Dev   = sd(vals_VLOAD),
    HPDI_2.5  = hpd_VLOAD$CI_low,
    HPDI_97.5 = hpd_VLOAD$CI_high,
    ESS       = ess_val_VLOAD
  )
}) %>% bind_rows()

print(summary_table_VLOAD)

# check that mcmcse < 6% of posterior SD
(100*summary_table_VLOAD$MCSE/summary_table_VLOAD$Std_Dev) < 6

```

LOO WAIC
```{r}
loglik_mat_VLOAD <- as_draws_matrix(fit.VLOAD$draws("log_lik"))  # iterations x N

# Get LOO-CV and WAIC
loo_res_VLOAD <- loo(loglik_mat_VLOAD)
print(loo_res_VLOAD)
```

```{r}
draws_VLOAD <- as_draws_array(fit$draws())  # dimensions: iterations x chains x parameters
draws_df_VLOAD <- as_draws_df(fit$draws())  # tidy format for bayesplot / ggplot
params_VLOAD <- c("beta[1]", "beta[2]", "beta[3]","beta[4]", "beta[5]", "beta[6]", "beta[7]", "beta[8]", "sigma")

mcmc_trace(draws_VLOAD, pars = params_VLOAD)

# R-hat and ESS diagnostics
# R-hat ≈ 1.00 → converged
# ESS should be reasonably large (e.g., >100–200 per parameter)
fit.VLOAD$summary(variables=params_VLOAD)


# Posterior Density Plots
# Overlaid densities from multiple chains should match closely
# If densities differ substantially between chains → poor mixing
mcmc_dens_overlay(draws_VLOAD, pars = params_VLOAD)

# Auto-correlation 
# Autocorrelation should decay quickly
# High autocorrelation → may need more iterations or thinning
mcmc_acf(draws_VLOAD, pars = params_VLOAD)

# Diagnostics from cmdstan
fit.VLOAD$cmdstan_diagnose()

```

Parameters for model with adherence

```{r}
y.VLOAD <- df$log_vload_2 
X.VLOAD.ADH <- model.matrix(~ log_vload_0 + hard_drugs + adh_2 + age + BMI + smoke + race + education, data = df)
N.VLOAD <- nrow(df)
P.VLOAD <- ncol(X.VLOAD.ADH)

m <-c(rep(0, P.VLOAD))
s <- rep(1000, P.VLOAD)
sigma_sd <- 1000
```


```{r}
# create data list to pass to STAN
data_list_VLOAD_ADH <- list(
  N = N.VLOAD,
  P = P.VLOAD,
  X = X.VLOAD.ADH,
  y = y.VLOAD,
  prior_mean = m,
  prior_sd = s,
  sigma_prior_sd = sigma_sd
)
```

```{r}
fit_VLOAD_ADH <- mod$sample(
  data = data_list_VLOAD_ADH,
  chains = 4,
  iter_warmup = 2000,
  iter_sampling = 10000,
  seed = 14
)
```


 Fancier Table of Results of Interest from the Posterior
# Extract posterior draws from cmdstanr fit
```{r}
draws_VLOAD_ADH <- fit_VLOAD_ADH$draws()  

draws_mat_VLOAD_ADH <- as_draws_matrix(draws_VLOAD_ADH)
params_VLOAD_ADH <- colnames(draws_mat_VLOAD_ADH)

# Exclude non-parameter columns from summarization: lp__ and log_lik[n]
params_VLOAD_ADH <- params_VLOAD_ADH[!grepl("lp__|log_lik", params_VLOAD_ADH)]


# Build summary table
summary_table_VLOAD_ADH <- lapply(params_VLOAD_ADH, function(p) {
  vals <- as.numeric(draws_mat_VLOAD_ADH[, p])
  
  # Monte Carlo standard error
  # Used to determine if we have run enough iterations
  # rule of thumb: MCSE should be less than 6.27% of the posterior standard deviation
  mcse_val <- mcmcse::mcse(vals)$se
  
  # Effective sample size
  ess_val <- ess_bulk(vals)
  
  # 95% HPDI
  hpd <- hdi(vals, ci = 0.95)
  
  tibble(
    Parameter = p,
    Estimate  = mean(vals),
    MCSE      = mcse_val,
    Std_Dev   = sd(vals),
    HPDI_2.5  = hpd$CI_low,
    HPDI_97.5 = hpd$CI_high,
    ESS       = ess_val
  )
}) %>% bind_rows()

print(summary_table_VLOAD_ADH)

# check that mcmcse < 6% of posterior SD
(100*summary_table_VLOAD_ADH$MCSE/summary_table_VLOAD_ADH$Std_Dev) < 6

```


LOO WAIC
```{r}
loglik_mat_VLOAD_ADH <- as_draws_matrix(fit_VLOAD_ADH$draws("log_lik"))  # iterations x N

# Get LOO-CV and WAIC
loo_res_VLOAD_ADH <- loo(loglik_mat_VLOAD_ADH)
print(loo_res_VLOAD_ADH)
```

```{r}
draws_VLOAD_ADH <- as_draws_array(fit_VLOAD_ADH$draws())  # dimensions: iterations x chains x parameters
draws_df_VLOAD_ADH <- as_draws_df(fit_VLOAD_ADH$draws())  # tidy format for bayesplot / ggplot
params_VLOAD_ADH <- c("beta[1]", "beta[2]", "beta[3]","beta[4]", "beta[5]", "beta[6]", "beta[7]", "beta[8]", "sigma")

mcmc_trace(draws_VLOAD_ADH, pars = params_VLOAD_ADH)

# R-hat and ESS diagnostics
# R-hat ≈ 1.00 → converged
# ESS should be reasonably large (e.g., >100–200 per parameter)
fit_VLOAD_ADH$summary(variables=params_VLOAD_ADH)


# Posterior Density Plots
# Overlaid densities from multiple chains should match closely
# If densities differ substantially between chains → poor mixing
mcmc_dens_overlay(draws_VLOAD_ADH, pars = params_VLOAD_ADH)

# Auto-correlation 
# Autocorrelation should decay quickly
# High autocorrelation → may need more iterations or thinning
mcmc_acf(draws_VLOAD_ADH, pars = params_VLOAD_ADH)

# Diagnostics from cmdstan
fit_VLOAD_ADH$cmdstan_diagnose()

```
