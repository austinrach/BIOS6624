---
title: "Project 1 Analysis"
author: "Rachel Austin"
date: "2026-02-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/austinra/BIOS6624/Project 1")
library(openxlsx)
library(dplyr)
library(tidyr)
```

Notes:
difference in difference model with baseline in predictor the same as a outcome with baseline as predictor
model with and without adherence for hard drug and non hard drugs

since var is so big intercept being at 0 is fine
focus on hard drug users and non hard drug users difference

8 models, 4 with primary 4 with QOL and adherence as mediator/covariate

QOL - 2 point change up or down clinically meaningful
CD4 - 50 cells up or down is meaningful
VLOAD - .5 decrease on log 10 up or down is meaningful


people using hard drugs might have a hard time with adherence - can differences found be explained by adherence For covariates should we use baseline or year 2?

We care about baseline. This is an observational study, not randomized so baseline will be important.

Viral load decreasing means treatment is working. CD4 increasing means immune function is improving. QOL scores important

Outcomes are strongly associated with each other. The outcomes are not independent, viral load and cd4 will be inversely related. Hopefully, QOL will improve when viral load decreases and cd4 increases.

If there are differences between subjects who use hard drugs and those who don't can that be explained by adherence levels?

10k MCMC should be enough cmdstan_diagnose should be used to check your models issues to check for: enough data for the model priors specified make sure to show diagnostic graphs


mediator.


```{r}
df <- read.xlsx("Data Processed/Analysis Dataset.xlsx")
df <- df %>% 
  mutate(newid = as.character(newid),
         AGG_MENT = as.numeric(AGG_MENT),
         AGG_PHYS = as.numeric(AGG_PHYS),
         BMI = as.numeric(BMI),
         SMOKE = factor(SMOKE, levels = c(1,2,3),  c("Never smoked", "Former smoker", "Current smoker")),
         age = as.numeric(age),
         years  = as.numeric(years))
```

Pivot dataframe
```{r}

#Difference in outcomes (year2 - year0)
delta_outcomes <- df %>%
  dplyr::select(newid, years, log_vload, sqrt_leu3n, AGG_MENT, AGG_PHYS) %>%
  pivot_wider(
    id_cols = newid,
    names_from = years,
    values_from = c(log_vload, sqrt_leu3n, AGG_MENT, AGG_PHYS),
    values_fn = mean
  ) %>%
  mutate(
    delta_log_vload = log_vload_2 - log_vload_0,
    delta_leu3n     = sqrt_leu3n_2 - sqrt_leu3n_0,
    delta_agg_ment  = AGG_MENT_2 - AGG_MENT_0,
    delta_agg_phys  = AGG_PHYS_2 - AGG_PHYS_0
  )

# Baseline covariates 
baseline_covars <- df %>%
  filter(years == 0) %>%
  select(newid, age, BMI, SMOKE, education, race) %>%
  group_by(newid) %>%
  summarise(dplyr::across(dplyr::everything(), ~ dplyr::first(.x)), .groups = "drop")

# Visit 2 covariates 
visit2_covars <- df %>%
  mutate(years = as.numeric(years)) %>%
  filter(years == 2) %>%
  select(newid, hard_drugs, ADH) %>%
  group_by(newid) %>%
  summarise(dplyr::across(dplyr::everything(), ~ dplyr::first(.x)), .groups = "drop")

#Combine into analysis dataset
change_data <- delta_outcomes %>%
  inner_join(baseline_covars, by = "newid") %>%
  inner_join(visit2_covars, by = "newid")

```

Frequentist Approach:

Laboratory Outcome: VLOAD
```{r}
vload.mod <- lm(delta_log_vload ~ log_vload_0+BMI + age + SMOKE + race + education + hard_drugs + ADH,
  data = change_data
)
summary(vload.mod)
```

