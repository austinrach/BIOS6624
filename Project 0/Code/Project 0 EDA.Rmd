---
title: "Project 0 EDA"
author: "Rachel Austin'
output: html_document
date: "2026-01-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(lubridate)
library(tidyr)
library(openxlsx)
```


```{r}
df <- read.csv("/Users/austinra/Downloads/Project0_Clean_v2.csv")
```

Missing values but time recorded- the sample could not be analyzed

Sample Interval Decimal Time MEMs and Booklet should not be used

Time since they reported waking up rather than calculated time intervals

Electronic cap - can malfunction if the battery is low, user error - not screwing the cap closed and there can be booklet error so neither of these should be considered the truth 

Agreement between subject's recordings of sample times compared to the times recorded by an electronic monitoring cap. x and y plot of these- is there a strong correlation or association. are people recording the time before or after the cap does? is there bias?

999 is missing

What are the changes to DHEA and cortisol over time?

Cortisol will rise 30 minutes after waking and decrease over the next 10 hours

Make sure to incorporate effects in report



Notes from 01/28/2026

Question 2: 
Are subjects adhering accurately to the +30 min and +10 hour sampling times required by a protocol?
Descriptive statistics okay maybe try a logistic regression analysis with random subject component
Or could pool all samples together

Adherence window
30 minutes and 10 hour after waking
One analysis for good adherence = 7.5 minutes before or after (inclusive) - proportion of those who met this
One analysis for adequate adherence = 15 minutes before or after (inclusive) - proportion of those who met this 
Need deviation variable for both cap and booklet
1. create var that is 30 min from waking and 10 hours
2. create diff variable


Question 3:
Spaghetti plot to determine patterns
Piecewise linear regression (lmm w random slope for subject) - maybe knot at 30 mins less interested in significance, more interested in magnitude/rate 
Maybe a spline  with a single knot at 30 mins

Booklet time or cap time - choose whichever you think is best from a statistical point of view

Biological Range of Data
Cortisol > 26 keep but weird, Cortisol > 80 incorrect - probably a laboratory error
DHEA upper limit on assay is 5.205 (max value in dataset) - probably an error unless this is recorded repeatedy by the same individual (probably exclude these individuals bc they have a different process going ons)
if there is good agreement we can impute, otherwise choose one time 


EDA:
```{r}
glimpse(df)
```
```{r}
#Fill in blank values with NA
df[df == ""] <- NA
```


```{r}
#SubjectID needs to be Categorical
df$SubjectID <- as.character(df$SubjectID)
#Collection.Date should be Date
df$Collection.Date <- as.Date(df$Collection.Date, format = "%m/%d/%Y")
#Collection.Sample should be Categorical
df$Collection.Sample <- as.factor(df$Collection.Sample)
#Booket..Clock.Time should be Time
df$Booket..Clock.Time <-hm(df$Booket..Clock.Time)
#MEMs..Clock.Time should be Time
df$MEMs..Clock.Time <- hm(df$MEMs..Clock.Time)

#Sleep.Diary.reported.wake.time should be Time and carried down for each SubjectID DAYNUMB combination
df$Sleep.Diary.reported.wake.time <- hm(df$Sleep.Diary.reported.wake.time)

df <- df %>%
  group_by(SubjectID, DAYNUMB) %>%
  fill(Sleep.Diary.reported.wake.time, .direction = "down") %>%
  ungroup()
```


#Sample Intervals should not be used in the analysis - calculate own values
#Booklet..Sample.interval is the Number of hours and minutes from waking recorded by participant formatted as hh:mm where waking was recorded as midnight 00:00
#Booklet..Sample.interval.Decimal.Time..mins. integer representation of previous variable aka number of minutes from waking for the sample as recorded by participant.
# MEMs..Sample.interval  Number of hours and minutes from waking electronic cap stamp formatted as hh:mm where waking was recorded as midnight 00:00
#MEMs..Sample.interval.Decimal.Time..mins. integer representation of previous variable aka number of minutes from waking electronic stamp.

```{r}
#Creating new variables capturing elapsed time between booklet and cap and wake time respectively

df <- df %>%
  mutate(
      cap_interval_mins =
      as.numeric(MEMs..Clock.Time, "seconds") / 60 -
      as.numeric(Sleep.Diary.reported.wake.time, "seconds") / 60,

    cap_sample_interval =
      sprintf("%02d:%02d",
              cap_interval_mins %/% 60,
              cap_interval_mins %% 60),

    booklet_interval_mins =
      as.numeric(Booket..Clock.Time, "seconds") / 60 -
      as.numeric(Sleep.Diary.reported.wake.time, "seconds") / 60,

    booklet_sample_interval =
      sprintf("%02d:%02d",
              booklet_interval_mins %/% 60,
              booklet_interval_mins %% 60)
  )

```




```{r}
#Group by SubjectID, Collection.Sample == 1 and fill in Booklet clock time with 0 if booket..clock.time is non-missing
df <- df %>%
  group_by(SubjectID) %>%
  mutate(
    booklet_interval_mins = if_else(
      Collection.Sample == 1 & !is.na(Booket..Clock.Time),
      0,
      booklet_interval_mins
    ),

    booklet_sample_interval =
      sprintf("%02d:%02d",
              booklet_interval_mins %/% 60,
              booklet_interval_mins %% 60)
  ) %>%
  ungroup()

```


#Cortisol..ug.dl., DHEA..pg.dl., Cortisol..nmol.L., DHEA..nmol.L. can be left as is
Outliers: Check no cortisol > 80, check no DHEA >5.205

```{r}
#Simple Visual of Cortisol Levels
plot(df$Cortisol..nmol.L.)
#One outlier with cortisol value > 80 - remove this
df <- filter(df, Cortisol..nmol.L. < 80)
```

```{r}
#Simple Visual of DHEA Levels
plot(df$DHEA..nmol.L.)
# These are fine - proceed without any DHEA changes
```

Save processed data
```{r}
#write.xlsx(df, "/Users/austinra/Documents/MS BIOS/Spring 2026/BIOS 6624/Project 0/Data Processed/Project0_ProcessedData.xlsx")
```

Question 1:
What is the agreement between the subject's recordings of sampling times compared to the times recorded by an electric monitoring cap?

```{r}
# Cap time distribution
ggplot(df %>% filter(!is.na(cap_interval_mins)),
       aes(cap_interval_mins)) +
  geom_histogram(binwidth = 10, fill = "steelblue", alpha = 0.8) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Cap minutes since wake",
    y = "Number of samples",
    title = "Cap Sampling Interval Distribution"
  )
 
#There are cap times with negative values, let's check how many
negative_captime <- df %>% filter(!is.na(cap_interval_mins) & cap_interval_mins < 0)
table(negative_captime$cap_interval_mins)
#14 cap times with negative values, this most likely means the participant recorded a wake time in their booklet later than they actually woke up

na_captime <- df%>% filter(is.na(cap_interval_mins))
table(na_captime$MEMs..Clock.Time, useNA = "ifany")
#Confirmed NA cap times are due to missing data not coding error
```


```{r}
# Book time distribution
```


```{r}
#Scatter plot of cap time (minutes) from waking up and booklet time (minutes) since waking up (continuous)
ggplot(df, aes(x = cap_interval_mins, y = booklet_interval_mins)) +
  geom_point(alpha = 0.6) +
  labs(
    x = "Cap interval (minutes since wake)",
    y = "Booklet interval (minutes since wake)",
    title = "Cap vs Booklet Minutes from Waking"
  ) +
  geom_abline(slope = 1, intercept = 0, color = "blue") +
  theme_minimal() +
  coord_equal()

```
```{r}
#Closer look at the bottom left corner of the graph - 
ggplot(df, aes(x = cap_interval_mins, y = booklet_interval_mins)) +
  geom_point(alpha = 0.6) +
  labs(
    x = "Cap interval (minutes since wake)",
    y = "Booklet interval (minutes since wake)",
    title = "Cap vs Booklet Minutes from Waking"
  ) +
  geom_abline(slope = 1, intercept = 0, color = "blue") +
  theme_minimal() +
  coord_equal()+ 
  coord_cartesian(xlim = c(-5,50),
                  ylim = c(-5, 50))
```

Each person has four samples per day over three days so they'll have twelve sampling times and twelve recorded cap times
Find the difference between recorded sampling time and recorded cap time, plot this distribution. (if missing don't include that data point)
Record rates of missingness between the caplet time and booklet time
Don't need to stratify by day or sample time

Look at difference between book and cap time in table one
Set up mixed model with book time as outcome, and cap as pred, random effect is subject
think about perfect agreement (intercept and slope - intercept : 0 , slope : 1 if negative then people consistently recording earlier and is positive then people consistently recording later)


Comparing sampling and electric monitoring cap, Mixed model 
pivot to long then implement the model with random component for subject and maybe sample # (check convergence)
Test of association, significant bias

```{r}

```


