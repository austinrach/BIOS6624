---
title: "Project 0 EDA"
author: "Rachel Austin'
output: html_document
date: "2026-01-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(lubridate)
library(tidyr)
library(openxlsx)
library(lme4)
library(lmerTest)
library(kableExtra)
```


```{r}
df <- read.csv("/Users/austinra/Downloads/Project0_Clean_v2.csv")
```

Missing values but time recorded- the sample could not be analyzed

Sample Interval Decimal Time MEMs and Booklet should not be used

Time since they reported waking up rather than calculated time intervals

Electronic cap - can malfunction if the battery is low, user error - not screwing the cap closed and there can be booklet error so neither of these should be considered the truth 

Agreement between subject's recordings of sample times compared to the times recorded by an electronic monitoring cap. x and y plot of these- is there a strong correlation or association. are people recording the time before or after the cap does? is there bias?

999 is missing

What are the changes to DHEA and cortisol over time?

Cortisol will rise 30 minutes after waking and decrease over the next 10 hours

Make sure to incorporate effects in report


EDA:
```{r}
glimpse(df)
```
```{r}
#Fill in blank values with NA
df[df == ""] <- NA
```


```{r}
#SubjectID needs to be Categorical
df$SubjectID <- as.character(df$SubjectID)
#Collection.Date should be Date
df$Collection.Date <- as.Date(df$Collection.Date, format = "%m/%d/%Y")
#Collection.Sample should be Categorical
df$Collection.Sample <- as.factor(df$Collection.Sample)
#Booket..Clock.Time should be Time
df$Booket..Clock.Time <-hm(df$Booket..Clock.Time)
#MEMs..Clock.Time should be Time
df$MEMs..Clock.Time <- hm(df$MEMs..Clock.Time)

#Sleep.Diary.reported.wake.time should be Time and carried down for each SubjectID DAYNUMB combination
df$Sleep.Diary.reported.wake.time <- hm(df$Sleep.Diary.reported.wake.time)

df <- df %>%
  group_by(SubjectID, DAYNUMB) %>%
  fill(Sleep.Diary.reported.wake.time, .direction = "down") %>%
  ungroup()
```


#Sample Intervals should not be used in the analysis - calculate own values
#Booklet..Sample.interval is the Number of hours and minutes from waking recorded by participant formatted as hh:mm where waking was recorded as midnight 00:00
#Booklet..Sample.interval.Decimal.Time..mins. integer representation of previous variable aka number of minutes from waking for the sample as recorded by participant.
# MEMs..Sample.interval  Number of hours and minutes from waking electronic cap stamp formatted as hh:mm where waking was recorded as midnight 00:00
#MEMs..Sample.interval.Decimal.Time..mins. integer representation of previous variable aka number of minutes from waking electronic stamp.

```{r}
#Creating new variables capturing elapsed time between booklet and cap and wake time respectively

df <- df %>%
  mutate(
      cap_interval_mins =
      as.numeric(MEMs..Clock.Time, "seconds") / 60 -
      as.numeric(Sleep.Diary.reported.wake.time, "seconds") / 60,

    cap_sample_interval =
      sprintf("%02d:%02d",
              cap_interval_mins %/% 60,
              cap_interval_mins %% 60),

    booklet_interval_mins =
      as.numeric(Booket..Clock.Time, "seconds") / 60 -
      as.numeric(Sleep.Diary.reported.wake.time, "seconds") / 60,

    booklet_sample_interval =
      sprintf("%02d:%02d",
              booklet_interval_mins %/% 60,
              booklet_interval_mins %% 60)
  )

```




```{r}
#Group by SubjectID, Collection.Sample == 1 and fill in Booklet clock time with 0 if booket..clock.time is non-missing
df <- df %>%
  group_by(SubjectID) %>%
  mutate(
    booklet_interval_mins = if_else(
      Collection.Sample == 1 & !is.na(Booket..Clock.Time),
      0,
      booklet_interval_mins
    ),

    booklet_sample_interval =
      sprintf("%02d:%02d",
              booklet_interval_mins %/% 60,
              booklet_interval_mins %% 60)
  ) %>%
  ungroup()

```


#Cortisol..ug.dl., DHEA..pg.dl., Cortisol..nmol.L., DHEA..nmol.L. can be left as is
Outliers: Check no cortisol > 80, check no DHEA >5.205

```{r}
#Simple Visual of Cortisol Levels
plot(df$Cortisol..nmol.L.)
#One outlier with cortisol value > 80 - remove this
df <- filter(df, Cortisol..nmol.L. < 80)
```

```{r}
#Simple Visual of DHEA Levels
plot(df$DHEA..nmol.L.)
# These are fine - proceed without any DHEA changes
```

Save processed data
```{r}
#write.xlsx(df, "/Users/austinra/Documents/MS BIOS/Spring 2026/BIOS 6624/Project 0/Data Processed/Project0_ProcessedData.xlsx")
```

Look at difference between book and cap time in table one

```{r}

```

Question 1:
What is the agreement between the subject's recordings of sampling times compared to the times recorded by an electric monitoring cap?

Record rates of missingness between the caplet time and booklet time

```{r}
# Cap time distribution
ggplot(df %>% filter(!is.na(cap_interval_mins)),
       aes(cap_interval_mins)) +
  geom_histogram(binwidth = 10, fill = "steelblue", alpha = 0.8) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Cap minutes since wake",
    y = "Number of samples",
    title = "Cap Sampling Interval Distribution"
  )
 
#There are cap times with negative values, let's check how many
negative_captime <- df %>% filter(!is.na(cap_interval_mins) & cap_interval_mins < 0)
table(negative_captime$cap_interval_mins)
#14 cap times with negative values, this most likely means the participant recorded a wake time in their booklet later than they actually woke up

na_captime <- df%>% filter(is.na(cap_interval_mins))
table(na_captime$cap_interval_mins, useNA = "ifany")
#57 missing cap_interval mins out of 366 observations
```


```{r}
# Book time distribution
ggplot(df %>% filter(!is.na(booklet_interval_mins)),
       aes(booklet_interval_mins)) +
  geom_histogram(binwidth = 10, fill = "steelblue", alpha = 0.8) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Booklet minutes since wake",
    y = "Number of samples",
    title = "Booklet Sampling Interval Distribution"
  )

#0 book times with negative values
negative_booklettime <- df %>% filter(!is.na(booklet_interval_mins) & booklet_interval_mins < 0)
table(negative_booklettime$booklet_interval_mins, useNA = "ifany")


na_booklettime <- df%>% filter(is.na(booklet_interval_mins))
table(na_booklettime$booklet_interval_mins, useNA = "ifany")
#31 missing booklet_interval_mins out of 366 observations
```

Removing observations with missing cap_interval_mins or missing booklet_interval_mins from df for this part of the analysis
```{r}
df_q1 <- filter(df, !is.na(cap_interval_mins) & !is.na(booklet_interval_mins))
```


```{r}
#Scatter plot of cap time (minutes) from waking up and booklet time (minutes) since waking up (continuous)
ggplot(df_q1, aes(x = cap_interval_mins, y = booklet_interval_mins)) +
  geom_point(alpha = 0.6) +
  labs(
    x = "Cap interval (minutes since wake)",
    y = "Booklet interval (minutes since wake)",
    title = "Cap vs Booklet Minutes from Waking"
  ) +
  geom_abline(slope = 1, intercept = 0, color = "blue") +
  theme_minimal() +
  coord_equal()
```




```{r}
#Closer look at the bottom left corner of the graph - 
ggplot(df_q1, aes(x = cap_interval_mins, y = booklet_interval_mins)) +
  geom_point(alpha = 0.6) +
  labs(
    x = "Cap interval (minutes since wake)",
    y = "Booklet interval (minutes since wake)",
    title = "Cap vs Booklet Minutes from Waking"
  ) +
  geom_abline(slope = 1, intercept = 0, color = "blue") +
  theme_minimal() +
  coord_equal()+ 
  coord_cartesian(xlim = c(min(df_q1$cap_interval_mins),50),
                  ylim = c(min(df_q1$booklet_interval_mins), 50))
```


Find the difference between recorded sampling time and recorded cap time, plot this distribution
```{r}
df_q1$booklet_cap_difference <- df_q1$booklet_interval_mins - df_q1$cap_interval_mins
ggplot(df_q1,
       aes(booklet_cap_difference)) +
  geom_histogram(binwidth = 10, fill = "steelblue", alpha = 0.8) +
  geom_text(
    stat = "bin",
    binwidth = 10,
    aes(label = after_stat(count)),
    vjust = -0.3,
    size = 3
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Booklet interval minus cap interval",
    y = "Number of samples",
    title = "Difference in Sampling Interval Distribution"
  )
```



Comparing booklet and electric monitoring cap using a mixed model:
```{r}
q1.lmm <- lmer(booklet_interval_mins ~ cap_interval_mins + (1|SubjectID), 
               data = df_q1)
summary(q1.lmm)
confint(q1.lmm)
```
For every 1 minute increase in recorded cap time, recorded booklet time increases by 0.995417 minutes (95% CI: 0.981, 1.010, p-value: <0.0001). This suggests there is strong agreement between recorded cap time and recorded booklet time. The intercept suggests there is bias though, subjects recorded sample collection in their booklet about 6.888 (95% CI: -12.685, -1.147, p-value: 0.022) minutes earlier than recorded sample collection by the electronic cap. 


Visualizing fit
```{r}
plot(q1.lmm)
qqnorm(residuals(q1.lmm))
qqline(residuals(q1.lmm))
```


The residuals are fairly close to 0 for most of the fitted values but there are a few observations with very large negative residuals. The qqplot shows the model is doing a good job fitting the majority of the data but there is strong deviation in the tails with some large negative and positive values. 

Visualizing fitted vs observed values
```{r}
df_q1 <- df_q1 %>% mutate(booklet_fitted = fitted(q1.lmm))

ggplot(df_q1,
       aes(x = booklet_fitted,
           y = booklet_interval_mins)) +
  geom_point(alpha = 0.6) +
  geom_abline(slope = 1, intercept = 0, color = "blue", linewidth = 1) +
  labs(
    x = "Fitted booklet interval (minutes)",
    y = "Observed booklet interval (minutes)",
    title = "Observed vs Fitted Booklet Sampling Times"
  ) +
  coord_equal() +
  theme_minimal(base_size = 14)

```


Question 2: 
Are subjects adhering accurately to the +30 min and +10 hour sampling times required by a protocol?

Adherence window
30 minutes (Collection 2) and 10 hours (Collection 4) after waking
One analysis for good adherence = 7.5 minutes before or after (inclusive) - proportion of those who met this
One analysis for adequate adherence = 15 minutes before or after (inclusive) - proportion of those who met this 

Wake time will be sleep diary reported wake time

Remember booklet_sample_interval is the amount of time between booklet sample and recorded wait time
So good adherence would be 22.5 to 37.5 for 30 minutes and 592.5 to 607.5 for 10 hours
Adequate adherence would be 15 to 45 for 30 minutes and 545 to 615 for 10 hours

Cap and booklet adherence: 
```{r}
#Create collection time var to grab samples we're interested in and booklet and cap deviation times from those collection windows
df <- df %>%
  mutate(
    collection_time = case_when(
      Collection.Sample == 2 ~ wake_plus_30min,
      Collection.Sample == 4 ~ wake_plus_10hr,
      TRUE ~ NA
    ),

    booklet_dev_mins =
      (as.numeric(Booket..Clock.Time, "seconds") -
       as.numeric(collection_time, "seconds")) / 60,

    cap_dev_mins =
      (as.numeric(MEMs..Clock.Time, "seconds") -
       as.numeric(collection_time, "seconds")) / 60
  )

```


```{r}
#Create variables checking for good and adequate adherence (inclusive)
df <- df %>%
  mutate(
    booklet_good = abs(booklet_dev_mins) <= 7.5,
    booklet_adequate = abs(booklet_dev_mins) <= 15,
    cap_good = abs(cap_dev_mins) <= 7.5,
    cap_adequate = abs(cap_dev_mins) <= 15
  )
```

Cap Adherence Deviation Visualization
```{r}
ggplot(df %>% filter(!is.na(cap_dev_mins)),
       aes(x = cap_dev_mins)) +
  geom_histogram(binwidth = 10, fill = "steelblue") +
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = c(-7.5, 7.5), linetype = "dashed") +
  geom_vline(xintercept = c(-15, 15), linetype = "dotted") +
  theme_minimal() +
  labs(
    x = "Cap deviation from target (minutes)",
    y = "Count",
    title = "Cap Sampling Deviations"
  )
```
Booklet Adherence Deviation
```{r}
ggplot(df %>% filter(!is.na(booklet_dev_mins)),
       aes(x = booklet_dev_mins)) +
  geom_histogram(binwidth = 10, fill = "steelblue") +
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = c(-7.5, 7.5), linetype = "dashed") +
  geom_vline(xintercept = c(-15, 15), linetype = "dotted") +
  theme_minimal() +
  labs(
    x = "Booklet deviation from target (minutes)",
    y = "Count",
    title = "Booklet Sampling Deviations"
  )

```
Let's see whether cap deviations vary by sample:
```{r}
ggplot(df %>% filter(!is.na(cap_dev_mins)),
       aes(factor(Collection.Sample), cap_dev_mins)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
  labs(
    x = "Sample",
    y = "Cap deviation (minutes)",
    title = "Cap Deviations by Sample"
  )

```
Let's see whether bookletdeviations vary by sample:
```{r}
ggplot(df %>% filter(!is.na(booklet_dev_mins)),
       aes(factor(Collection.Sample), booklet_dev_mins)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
  labs(
    x = "Sample",
    y = "Booklet deviation (minutes)",
    title = "Booklet Deviations by Sample"
  )
```


Summary Table describing Adherence by Sample for Booklet and Caps
```{r}
sample_props <- df %>%
  filter(Collection.Sample %in% c(2, 4)) %>%  
  group_by(Collection.Sample) %>%
  summarize(
    cap_good = mean(cap_good, na.rm = TRUE),
    cap_adequate = mean(cap_adequate, na.rm = TRUE),
    booklet_good = mean(booklet_good, na.rm = TRUE),
    booklet_adequate = mean(booklet_adequate, na.rm = TRUE),
    n_samples = n()
  )

kable(sample_props)
#polish this table for report!
```


Question 3:
Spaghetti plot to determine patterns
Piecewise linear regression (lmm w random slope for subject) - maybe knot at 30 mins less interested in significance, more interested in magnitude/rate 
Maybe a spline  with a single knot at 30 mins

Booklet time or cap time - choose whichever you think is best from a statistical point of view

Biological Range of Data
Cortisol > 26 keep but weird, Cortisol > 80 incorrect - probably a laboratory error
DHEA upper limit on assay is 5.205 (max value in dataset) - probably an error unless this is recorded repeatedly by the same individual (probably exclude these individuals bc they have a different process going on)
if there is good agreement we can impute, otherwise choose one time 

```{r}
#Visualize cortisol
hist(df$Cortisol..nmol.L.)
#Heavy right skew - let's look at a log transformation
hist(log(df$Cortisol..nmol.L.))
```
```{r}
#Visualizing DHEA
hist(df$DHEA..nmol.L.)
#Again heavy right skew - let's look at the log transform
hist(log(df$DHEA..nmol.L.))
```
Check for missing Cortisol values:
```{r}
#Previously removed Cortisol (nmol/L) with levels above 80, these should return 0 
sum(is.na(df$Cortisol..nmol.L.))
sum(is.na(df$Cortisol..ug.dl.))
```

Check for missing DHEA
```{r}
sum(is.na(df$DHEA..nmol.L.))
```

