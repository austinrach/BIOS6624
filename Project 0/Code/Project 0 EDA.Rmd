---
title: "Project 0 EDA"
author: "Rachel Austin'
output: html_document
date: "2026-01-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(lubridate)
library(tidyr)
library(openxlsx)
library(lme4)
library(lmerTest)
library(kableExtra)
library(segmented)
library(tableone)
library(ggplot2)
```


```{r}
df <- read.csv("/Users/austinra/Documents/MS BIOS/Spring 2026/BIOS 6624/Project 0/Data Raw/Project0_Clean_v2.csv")
```


Missing values but time recorded- the sample could not be analyzed
Sample Interval Decimal Time MEMs and Booklet should not be used
9999 is missing

EDA:
```{r}
glimpse(df)
```
```{r}
#Fill in blank values with NA
library(dplyr)
library(stringr)

df %>%
  summarise(
    across(
      everything(),
      list(
        blank = ~ sum(str_trim(as.character(.x)) == "", na.rm = TRUE),
        na = ~ sum(is.na(.x))
      )
    )
  )

#35 blank booket clock time
#61 blank mems clock time
#279 blank sleep diary reported wake time
#5 cortisol na, 5 dhea na

#Need to fill in these blanks with NA values
df <- df %>%
  mutate(
    across(
      c(Booket..Clock.Time, MEMs..Clock.Time, Sleep.Diary.reported.wake.time),
      ~ na_if(str_trim(.x), "")
    )
  )

```


```{r}
#SubjectID needs to be Categorical
df$SubjectID <- as.character(df$SubjectID)
#Collection.Date should be Date
df$Collection.Date <- as.Date(df$Collection.Date, format = "%m/%d/%Y")
#Collection.Sample should be Categorical
df$Collection.Sample <- as.factor(df$Collection.Sample)
#Booket..Clock.Time should be Time
df$Booket..Clock.Time <-hm(df$Booket..Clock.Time)
#MEMs..Clock.Time should be Time
df$MEMs..Clock.Time <- hm(df$MEMs..Clock.Time)
#Sleep.Diary.reported.wake.time should be Time 
df$Sleep.Diary.reported.wake.time <- hm(df$Sleep.Diary.reported.wake.time)

#Sleep.Diary.reported.wake.time carried down for each SubjectID DAYNUMB combination
df <- df %>%
  group_by(SubjectID, DAYNUMB) %>%
  fill(Sleep.Diary.reported.wake.time, .direction = "down") %>%
  ungroup()
```


#Sample Intervals should not be used in the analysis - calculate own values
#Booklet..Sample.interval is the Number of hours and minutes from waking recorded by participant formatted as hh:mm where waking was recorded as midnight 00:00
#Booklet..Sample.interval.Decimal.Time..mins. integer representation of previous variable aka number of minutes from waking for the sample as recorded by participant.
# MEMs..Sample.interval  Number of hours and minutes from waking electronic cap stamp formatted as hh:mm where waking was recorded as midnight 00:00
#MEMs..Sample.interval.Decimal.Time..mins. integer representation of previous variable aka number of minutes from waking electronic stamp.

```{r}
#Creating new variables capturing elapsed time between booklet and cap and wake time respectively
df <- df %>%
  mutate(
    wake_mins    = hour(Sleep.Diary.reported.wake.time) * 60 + minute(Sleep.Diary.reported.wake.time),
    cap_mins     = hour(MEMs..Clock.Time)               * 60 + minute(MEMs..Clock.Time),
    booklet_mins = hour(Booket..Clock.Time)             * 60 + minute(Booket..Clock.Time),

    cap_interval_mins     = cap_mins - wake_mins,
    booklet_interval_mins = booklet_mins - wake_mins
  )


```


Check each SubjectID has proper number of samples
```{r}
summary <- df %>% group_by(SubjectID, DAYNUMB) %>% summarize(n = n()) %>% ungroup()
#Subject 3029 has 12 observations on day 3 - let's see what's going on
problem_subj <- filter(df, SubjectID == 3029)

#Assign new DAYNUMB based on date for this subject
df <- df %>%
  mutate(
    DAYNUMB = case_when(
      SubjectID == 3029 & Collection.Date == "2018-10-07" ~ 1,
      SubjectID == 3029 & Collection.Date == "2018-10-10" ~ 2,
      SubjectID == 3029 & Collection.Date == "2018-10-12" ~ 3,
      TRUE ~ DAYNUMB
    )
  ) %>% ungroup()

```


Save processed data
```{r}
#write.xlsx(df, "/Users/austinra/Documents/MS BIOS/Spring 2026/BIOS 6624/Project 0/Data Processed/Project0_ProcessedData.xlsx")
```

Table One
Group by Sample Time, Display 
```{r}
myVars <- c("Cortisol..nmol.L.", "DHEA..nmol.L.", "cap_interval_mins", "booklet_interval_mins")

tab1 <-CreateTableOne(vars = myVars, data =df, strata = "Collection.Sample")
tab1
summary(tab1)
```

Question 1:
What is the agreement between the subject's recordings of sampling times compared to the times recorded by an electric monitoring cap?

Record rates of missingness between the caplet time and booklet time

```{r}
# Cap time distribution
ggplot(df %>% filter(!is.na(cap_interval_mins)),
       aes(cap_interval_mins)) +
  geom_histogram(binwidth = 10, fill = "steelblue", alpha = 0.8) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Cap minutes since wake",
    y = "Number of samples",
    title = "Cap Sampling Interval Distribution"
  )
 
#There are cap times with negative values, let's check how many
negative_captime <- df %>% filter(!is.na(cap_interval_mins) & cap_interval_mins < 0)
table(negative_captime$cap_interval_mins)
#14 cap times with negative values, this most likely means the participant recorded a wake time in their booklet later than they actually woke up

na_captime <- df%>% filter(is.na(cap_interval_mins))
table(na_captime$cap_interval_mins, useNA = "ifany")
#61 missing cap_interval mins out of 366 observations
```


```{r}
# Book time distribution
ggplot(df %>% filter(!is.na(booklet_interval_mins)),
       aes(booklet_interval_mins)) +
  geom_histogram(binwidth = 10, fill = "steelblue", alpha = 0.8) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Booklet minutes since wake",
    y = "Number of samples",
    title = "Booklet Sampling Interval Distribution"
  )

#0 book times with negative values
negative_booklettime <- df %>% filter(!is.na(booklet_interval_mins) & booklet_interval_mins < 0)
table(negative_booklettime$booklet_interval_mins, useNA = "ifany")


na_booklettime <- df%>% filter(is.na(booklet_interval_mins))
table(na_booklettime$booklet_interval_mins, useNA = "ifany")
#35 missing booklet_interval_mins out of 366 observations
```

Removing observations with missing cap_interval_mins or missing booklet_interval_mins from df for this part of the analysis
```{r}
df_q1 <- filter(df, !is.na(cap_interval_mins) & !is.na(booklet_interval_mins))
```


```{r}
#Scatter plot of cap time (minutes) from waking up and booklet time (minutes) since waking up (continuous)
ggplot(df_q1, aes(x = cap_interval_mins, y = booklet_interval_mins)) +
  geom_point(alpha = 0.6) +
  labs(
    x = "Cap interval (minutes since wake)",
    y = "Booklet interval (minutes since wake)",
    title = "Cap vs Booklet Minutes from Waking"
  ) +
  geom_abline(slope = 1, intercept = 0, color = "blue") +
  theme_minimal() +
  coord_equal()
```




```{r}
#Closer look at the bottom left corner of the graph - 
ggplot(df_q1, aes(x = cap_interval_mins, y = booklet_interval_mins)) +
  geom_point(alpha = 0.6) +
  labs(
    x = "Cap interval (minutes since wake)",
    y = "Booklet interval (minutes since wake)",
    title = "Cap vs Booklet Minutes from Waking"
  ) +
  geom_abline(slope = 1, intercept = 0, color = "blue") +
  theme_minimal() +
  coord_equal()+ 
  coord_cartesian(xlim = c(min(df_q1$cap_interval_mins),50),
                  ylim = c(min(df_q1$booklet_interval_mins), 50))
```


Find the difference between recorded sampling time and recorded cap time, plot this distribution
```{r}
df_q1$booklet_cap_difference <- df_q1$booklet_interval_mins - df_q1$cap_interval_mins
ggplot(df_q1,
       aes(booklet_cap_difference)) +
  geom_histogram(binwidth = 10, fill = "steelblue", alpha = 0.8) +
  geom_text(
    stat = "bin",
    binwidth = 10,
    aes(label = after_stat(count)),
    vjust = -0.3,
    size = 3
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Booklet interval minus cap interval",
    y = "Number of samples",
    title = "Difference in Sampling Interval Distribution"
  )
```



Comparing booklet and electric monitoring cap using a mixed model:
```{r}
q1.lmm <- lmer(booklet_interval_mins ~ cap_interval_mins + (1|SubjectID), 
               data = df_q1)
summary(q1.lmm)
confint(q1.lmm)
```
For every 1 minute increase in recorded cap time, recorded booklet time increases by 0.995 minutes (95% CI: 0.981, 1.001, p-value: <0.0001). This suggests there is strong agreement between recorded cap time and recorded booklet time. The intercept suggests there is bias though, subjects recorded sample collection in their booklet about 6.507 (95% CI: -12.257, -0.798, p-value: 0.029) minutes earlier than recorded sample collection by the electronic cap. 


Visualizing fit
```{r}
plot(q1.lmm)
qqnorm(residuals(q1.lmm))
qqline(residuals(q1.lmm))
```


The residuals are fairly close to 0 for most of the fitted values but there are a few observations with very large negative residuals. The qqplot shows the model is doing a good job fitting the majority of the data but there is strong deviation in the tails with some large negative and positive values. 

Visualizing fitted vs observed values
```{r}
df_q1 <- df_q1 %>% mutate(booklet_fitted = fitted(q1.lmm))

ggplot(df_q1,
       aes(x = booklet_fitted,
           y = booklet_interval_mins)) +
  geom_point(alpha = 0.6) +
  geom_abline(slope = 1, intercept = 0, color = "blue", linewidth = 1) +
  labs(
    x = "Fitted booklet interval (minutes)",
    y = "Observed booklet interval (minutes)",
    title = "Observed vs Fitted Booklet Sampling Times"
  ) +
  coord_equal() +
  theme_minimal(base_size = 14)

```


Question 2: 
Are subjects adhering accurately to the +30 min and +10 hour sampling times required by a protocol?

Adherence window
30 minutes (Collection 2) and 10 hours (Collection 4) after waking
One analysis for good adherence = 7.5 minutes before or after (inclusive) - proportion of those who met this
One analysis for adequate adherence = 15 minutes before or after (inclusive) - proportion of those who met this 

Wake time will be sleep diary reported wake time

Remember booklet_sample_interval is the amount of time between booklet sample and recorded wait time
So good adherence would be 22.5 to 37.5 for 30 minutes and 592.5 to 607.5 for 10 hours
Adequate adherence would be 15 to 45 for 30 minutes and 545 to 615 for 10 hours

Cap and booklet adherence: 
```{r}
#Create collection time var to grab samples we're interested in and booklet and cap deviation times from those collection windows
df_q2 <- df %>% mutate(
    target_mins = case_when(
      Collection.Sample == 2 ~ 30,
      Collection.Sample == 4 ~ 600,
      TRUE ~ NA_real_
    ),

    cap_dev     = cap_interval_mins     - target_mins,
    booklet_dev = booklet_interval_mins - target_mins,

    cap_good         = if_else(!is.na(target_mins), abs(cap_dev) <= 7.5, NA),
    cap_adequate     = if_else(!is.na(target_mins), abs(cap_dev) <= 15,  NA),

    booklet_good     = if_else(!is.na(target_mins), abs(booklet_dev) <= 7.5, NA),
    booklet_adequate = if_else(!is.na(target_mins), abs(booklet_dev) <= 15,  NA)
  )

#Summary Table describing Adherence by Sample for Booklet and Caps

df_q2 %>%
  filter(Collection.Sample %in% c(2, 4)) %>%
  summarise(
    n = n(),
    booklet_good_prop     = mean(booklet_good, na.rm = TRUE),
    booklet_adequate_prop = mean(booklet_adequate, na.rm = TRUE),
    cap_good_prop         = mean(cap_good, na.rm = TRUE),
    cap_adequate_prop     = mean(cap_adequate, na.rm = TRUE)
  )


```

Cap Adherence Deviation Visualization
```{r}
ggplot(df_q2 %>% filter(!is.na(cap_dev)),
       aes(x = cap_dev)) +
  geom_histogram(binwidth = 10, fill = "steelblue") +
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = c(-7.5, 7.5), linetype = "dashed") +
  geom_vline(xintercept = c(-15, 15), linetype = "dotted") +
  theme_minimal() +
  labs(
    x = "Cap deviation from target (minutes)",
    y = "Count",
    title = "Cap Sampling Deviations"
  )
```
Booklet Adherence Deviation
```{r}
ggplot(df_q2 %>% filter(!is.na(booklet_dev)),
       aes(x = booklet_dev)) +
  geom_histogram(binwidth = 10, fill = "steelblue") +
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = c(-7.5, 7.5), linetype = "dashed") +
  geom_vline(xintercept = c(-15, 15), linetype = "dotted") +
  theme_minimal() +
  labs(
    x = "Booklet deviation from target (minutes)",
    y = "Count",
    title = "Booklet Sampling Deviations"
  )

```
Let's see whether cap deviations vary by sample:
```{r}
ggplot(df_q2 %>% filter(!is.na(cap_dev)),
       aes(factor(Collection.Sample), cap_dev)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
  labs(
    x = "Sample",
    y = "Cap deviation (minutes)",
    title = "Cap Deviations by Sample"
  )

```
Let's see whether bookletdeviations vary by sample:
```{r}
ggplot(df_q2 %>% filter(!is.na(booklet_dev)),
       aes(factor(Collection.Sample), booklet_dev)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
  labs(
    x = "Sample",
    y = "Booklet deviation (minutes)",
    title = "Booklet Deviations by Sample"
  )
```




Question 3:
Spaghetti plot to determine patterns
Piecewise linear regression (lmm w random slope for subject) - maybe knot at 30 mins less interested in significance, more interested in magnitude/rate 
Maybe a spline  with a single knot at 30 mins

Booklet time or cap time - choose whichever you think is best from a statistical point of view

Biological Range of Data
Cortisol > 26 keep but weird, Cortisol > 80 incorrect - probably a laboratory error
DHEA upper limit on assay is 5.205 (max value in dataset - exclude these) - probably an error unless this is recorded repeatedly by the same individual (probably exclude these individuals bc they have a different process going on)
#Cortisol..ug.dl., DHEA..pg.dl., Cortisol..nmol.L., DHEA..nmol.L. can be left as is
Outliers: Check no cortisol > 80, check no DHEA >5.205

```{r}
#One outlier with cortisol value > 80 - remove this
df_q3 <- filter(df, Cortisol..nmol.L. < 80)
#DHEA 
x <- filter(df_q3,DHEA..nmol.L. == 5.205)
#SubjectID 3037 needs to be be removed as it is at the upper limit multiple times, suggesting something is wrong
df_q3 <- filter(df_q3, SubjectID != 3037)
```


```{r}
#Visualize cortisol
hist(df_q3$Cortisol..nmol.L., main = "Histogram of Cortisol (nmol/L")
#Heavy right skew - let's look at a log transformation
hist(log(df_q3$Cortisol..nmol.L.), main = "Histogram of Cortisol (nmol/L")
```
```{r}
#Visualizing DHEA
hist(df_q3$DHEA..nmol.L.)
#Again heavy right skew - let's look at the log transform
hist(log(df_q3$DHEA..nmol.L.))
#Let's proceed with logging this variable
```
Check for missing Cortisol values:
```{r}
#Previously removed Cortisol (nmol/L) with levels above 80, these should return 0 
sum(is.na(df_q3$Cortisol..nmol.L.))
sum(is.na(df_q3$Cortisol..ug.dl.))
```

Check for missing DHEA
```{r}
sum(is.na(df_q3$DHEA..nmol.L.))
```
What are the patterns of change over the course of the day? What is the investigator interested in knowing about changes over time?
The investigator stated that levels of cortisol and DHEA are expected to increase sharply from waking to 30 minutes after waking and then decline more slowly over the rest of the day.
She was interested in knowing if the SPIT test shows this expected pattern.
She wanted to know: 1) is there an increase in cortisol and/or DHEA from waking to 30 minutes post waking? And 2) what is the rate of decline in cortisol and DHEA after 30 minutes from waking?
She also stated that even if there are not statistically significant differences, she would like to know the estimates for the initial increase and rates of decline so she can compare them to what is known from other more standard hormone tests.


Significant outlier
```{r}
ggplot(df_q3, aes(x = cap_interval_mins, y = Cortisol..nmol.L., group = SubjectID)) +
  geom_line() +
  theme_minimal(base_size = 14) +
  labs(
    x = "Minutes since waking (cap)",
    y = "Cortisol (nmol/L)",
    title = "Cortisol Over Time Since Waking"
  )
```

```{r}
ggplot(df_q3, aes(x = cap_interval_mins, y = DHEA..nmol.L., group = SubjectID)) +
  geom_line() +
  theme_minimal(base_size = 14) +
  labs(
    x = "Minutes since waking (cap)",
    y = "DHEA (nmol/L)",
    title = "DHEA Over Time Since Waking"
  )
```




Create variable for 30 minute knot
```{r}
#Modified from BIOS 6643 code- changepoint creation
df_q3 <- df_q3 %>%
  mutate(
    wake_30 = pmin(cap_interval_mins, 30),
    after_30 = pmax(cap_interval_mins - 30, 0),
    log_cortisol = log(Cortisol..nmol.L.),
    log_dhea = log(DHEA..nmol.L.)
  )

```


Piecewise linear regression (lmm w random slope for subject) - maybe knot at 30 mins less interested in significance, more interested in magnitude/rate 
```{r}
q3_cortisol.lmm <- lmer(
  log_cortisol ~ wake_30 + after_30 + (1 | SubjectID),
  data = df_q3
)
summary(q3_cortisol.lmm)
exp(fixef(q3_cortisol.lmm))
exp(confint(q3_cortisol.lmm))
```
Intercept - waking cortisol
per min during first 30
per min post 30
```{r}
q3_dhea.lmm <- lmer(
  log_dhea ~ wake_30 + after_30 + (1 | SubjectID),
  data = df_q3
)
summary(q3_dhea.lmm)

```

If this is a value great than 1, you can subtract 1 and multiply by 100 to get the % increase associated with a 1-unit increase in X1.

If this value is less than 1, you can subtract 1 and multiple by 100 to get the % decrease associated with a 1-unit increase in X1.

This means that exp(beta1) can be roughly interpreted as the percentage change in of Y with a one unit increase in X1.


