---
title: "Project 0 EDA"
author: "Rachel Austin"
output: html_document
date: "2026-01-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(lubridate)
library(tidyr)
library(openxlsx)
library(lme4)
library(lmerTest)
library(kableExtra)
library(segmented)
library(tableone)
library(ggplot2)
library(broom.mixed)
library(stringr)
```


```{r}
df <- read.csv("/Users/austinra/BIOS6624/Project 0/Data Raw/Project0_Clean_v2.csv")
```


EDA:
```{r}
glimpse(df)
```


```{r}
#Examine which values are blank and which are NA
df %>%
  summarise(
    across(
      everything(),
      list(
        blank = ~ sum(str_trim(as.character(.x)) == "", na.rm = TRUE),
        na = ~ sum(is.na(.x))
      )
    )
  )

#35 blank Booket..Clock.Time
#61 blank MEMs..Clock.Time
#279 blank Sleep.Diary.reported.wake.time
#5 Cortisol..nmol.L._na, 5 DHEA..nmol.L._na
```
Check each SubjectID has proper number of samples
```{r}
problem_check <- df %>% group_by(SubjectID, DAYNUMB) %>% summarize(n = n()) %>% filter(n > 4)

#Subject 3029 has 12 observations on day 3, assign new DAYNUMB based on date for this subject
df_mod <- df %>%
  mutate(Collection.Date = as.Date(Collection.Date, format = "%m/%d/%Y")) %>%
  mutate(
    DAYNUMB = case_when(
      SubjectID == 3029 & Collection.Date == "2018-10-07" ~ 1,
      SubjectID == 3029 & Collection.Date == "2018-10-10" ~ 2,
      SubjectID == 3029 & Collection.Date == "2018-10-12" ~ 3,
      TRUE ~ DAYNUMB
    )
  ) %>% ungroup()


```




Modify variable types
```{r}
#SubjectID needs to be Categorical
df_mod$SubjectID <- as.character(df_mod$SubjectID)
#Collection.Sample should be Categorical
df_mod$Collection.Sample <- as.character(df_mod$Collection.Sample)
#Booket..Clock.Time should be Time
df_mod$Booket..Clock.Time <-hm(df_mod$Booket..Clock.Time)
#MEMs..Clock.Time should be Time
df_mod$MEMs..Clock.Time <- hm(df_mod$MEMs..Clock.Time)
#Sleep.Diary.reported.wake.time should be Time 
df_mod$Sleep.Diary.reported.wake.time <- hm(df_mod$Sleep.Diary.reported.wake.time)


#Sleep.Diary.reported.wake.time carried down for each SubjectID DAYNUMB combination
df_mod <- df_mod %>%
  arrange(
    SubjectID,
    DAYNUMB,
    suppressWarnings(as.integer(Collection.Sample))
  ) %>%
  group_by(SubjectID, DAYNUMB) %>%
  tidyr::fill(Sleep.Diary.reported.wake.time, .direction = "down") %>%
  ungroup()

```


#Sample Intervals should not be used in the analysis - calculate own values
#Booklet..Sample.interval is the Number of hours and minutes from waking recorded by participant formatted as hh:mm where waking was recorded as midnight 00:00
#Booklet..Sample.interval.Decimal.Time..mins. integer representation of previous variable aka number of minutes from waking for the sample as recorded by participant.
# MEMs..Sample.interval  Number of hours and minutes from waking electronic cap stamp formatted as hh:mm where waking was recorded as midnight 00:00
#MEMs..Sample.interval.Decimal.Time..mins. integer representation of previous variable aka number of minutes from waking electronic stamp.

```{r}
# Convert times to minutes since midnight
df_mod$booklet_mins <- lubridate::hour(df_mod$Booket..Clock.Time) * 60 +
                          lubridate::minute(df_mod$Booket..Clock.Time)

df_mod$cap_mins <- lubridate::hour(df_mod$MEMs..Clock.Time) * 60 +
                      lubridate::minute(df_mod$MEMs..Clock.Time)

df_mod$wake_mins <- lubridate::hour(df_mod$Sleep.Diary.reported.wake.time) * 60 +
                       lubridate::minute(df_mod$Sleep.Diary.reported.wake.time)


#Creating new variables capturing elapsed time between booklet and wake time AND cap and wake time respectively
df_mod$cap_interval_mins <-
  df_mod$cap_mins - df_mod$wake_mins

df_mod$booklet_interval_mins <-
  df_mod$booklet_mins - df_mod$wake_mins

```



```{r}
glimpse(df_mod)
```

Save processed data
```{r}
#write.xlsx(df_mod, "/Users/austinra/BIOS6624/Project 0/Data Processed/Project0_ProcessedData.xlsx")
```

Table One
Group by Sample Time, Display 
```{r}
myVars <- c("Cortisol..nmol.L.", "DHEA..nmol.L.", "cap_interval_mins", "booklet_interval_mins")

tab1 <-CreateTableOne(vars = myVars, data =df_mod, strata = "Collection.Sample")
tab1
summary(tab1)
```

Question 1:
What is the agreement between the subject's recordings of sampling times compared to the times recorded by an electric monitoring cap?

Record rates of missingness between the caplet time and booklet time

```{r}
# Cap time distribution
ggplot(df_mod %>% filter(!is.na(cap_interval_mins)),
       aes(cap_interval_mins)) +
  geom_histogram(binwidth = 10, fill = "steelblue", alpha = 0.8) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Cap minutes since wake",
    y = "Number of samples",
    title = "Cap Sampling Interval Distribution"
  )
 
#There are cap times with negative values, let's check how many
negative_captime <- df_mod %>% filter(!is.na(cap_interval_mins) & cap_interval_mins < 0)
table(negative_captime$cap_interval_mins)
#14 cap times with negative values, this most likely means the participant recorded a wake time in their booklet later than they actually woke up

na_captime <- df_mod%>% filter(is.na(cap_interval_mins))
table(na_captime$cap_interval_mins, useNA = "ifany")
#61 missing cap_interval mins out of 366 observations
```


```{r}
# Book time distribution
ggplot(df_mod %>% filter(!is.na(booklet_interval_mins)),
       aes(booklet_interval_mins)) +
  geom_histogram(binwidth = 10, fill = "steelblue", alpha = 0.8) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Booklet minutes since wake",
    y = "Number of samples",
    title = "Booklet Sampling Interval Distribution"
  )

#2 book times with negative values
negative_booklettime <- df_mod %>% filter(!is.na(booklet_interval_mins) & booklet_interval_mins < 0)
table(negative_booklettime$booklet_interval_mins, useNA = "ifany")


na_booklettime <- df_mod%>% filter(is.na(booklet_interval_mins))
table(na_booklettime$booklet_interval_mins, useNA = "ifany")
#35 missing booklet_interval_mins out of 366 observations
```

Removing observations with missing cap_interval_mins or missing booklet_interval_mins from df_mod for this part of the analysis
```{r}
#Drop all observations where either of these values are missing
df_q1 <- filter(df_mod, !is.na(cap_interval_mins) & !is.na(booklet_interval_mins))
```


```{r}
#Scatter plot of cap time (minutes) from waking up and booklet time (minutes) since waking up (continuous)
ggplot(df_q1, aes(x = cap_interval_mins, y = booklet_interval_mins)) +
  geom_point(alpha = 0.6) +
  labs(
    x = "Cap interval (minutes since wake)",
    y = "Booklet interval (minutes since wake)",
    title = "Cap vs Booklet Minutes from Waking"
  ) +
  geom_abline(slope = 1, intercept = 0, color = "blue") +
  theme_minimal() +
  coord_equal()
```



Find the difference between recorded sampling time and recorded cap time and print summary statistics
```{r}
df_q1$booklet_cap_difference <- df_q1$booklet_interval_mins - df_q1$cap_interval_mins
summary(df_q1$booklet_cap_difference)
```
We have no NA values, as expected, and booklet time is often recorded earlier than cap time.


Plot distribution of the difference between booklet sampling time and cap sampling time
```{r}
ggplot(df_q1,
       aes(booklet_cap_difference)) +
  geom_histogram(binwidth = 10, fill = "steelblue", alpha = 0.8) +
  geom_text(
    stat = "bin",
    binwidth = 10,
    aes(label = after_stat(count)),
    vjust = -0.3,
    size = 3
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Booklet interval minus cap interval",
    y = "Number of samples",
    title = "Difference in Sampling Interval Distribution"
  )
```
Booklet and Cap Time fall pretty close together with some extreme outliers representing large differences between recorded booklet time and cap time.

Comparing booklet and electric monitoring cap using a mixed model:
```{r}
q1.lmm <- lmer(booklet_interval_mins ~ cap_interval_mins + (1|SubjectID), 
               data = df_q1)
summary(q1.lmm)
confint(q1.lmm)
```
For every 1 minute increase in recorded cap time, recorded booklet time increases by 0.995 minutes (95% CI: 0.981, 1.008, p-value: <0.0001). This suggests there is strong agreement between recorded cap time and recorded booklet time. The intercept suggests there is bias though, subjects recorded sample collection in their booklet about 6.508 (95% CI: -12.259, -0.799, p-value: 0.029) minutes earlier than recorded sample collection by the electronic cap. 


Visualizing fit
```{r}
plot(q1.lmm)
qqnorm(residuals(q1.lmm))
qqline(residuals(q1.lmm))
```


The residuals are fairly close to 0 for most of the fitted values but there are a few observations with very large negative residuals. The qqplot shows the model is doing a good job fitting the majority of the data but there is strong deviation in the tails with some large negative and positive values. 

Visualizing fitted vs observed values with identity line and fitted line
```{r}
pred_q1 <- tibble(
  cap_interval_mins = seq(min(df_q1$cap_interval_mins, na.rm = TRUE),
                          max(df_q1$cap_interval_mins, na.rm = TRUE),
                          length.out = 200)
)

pred_q1$booklet_pred <- predict(q1.lmm, newdata = pred_q1, re.form = NA)

ggplot(df_q1, aes(x = cap_interval_mins, y = booklet_interval_mins)) +
  geom_point(alpha = 0.6) +
  geom_line(
    data = pred_q1,
    aes(x = cap_interval_mins, y = booklet_pred),
    inherit.aes = FALSE,
    color = "red"
  ) +
  labs(
    x = "Cap interval (minutes since wake)",
    y = "Booklet interval (minutes since wake)",
    title = "Cap vs Booklet Minutes from Waking"
  ) +
  geom_abline(slope = 1, intercept = 0, color = "blue") +
  theme_minimal() +
  coord_equal()


```


Question 2: 
Are subjects adhering accurately to the +30 min and +10 hour sampling times required by a protocol?

Adherence window
30 minutes (Collection 2) and 10 hours (Collection 4) after waking
One analysis for good adherence = 7.5 minutes before or after (inclusive) - proportion of those who met this
One analysis for adequate adherence = 15 minutes before or after (inclusive) - proportion of those who met this #Create collection time var to grab samples we're interested in and booklet and cap deviation times from those collection windows

```{r}
df_q2 <- filter(df_mod, Collection.Sample %in% c("2","4"))

df_q2 <- df_q2 %>%
  mutate(
    cap_good = case_when(
      Collection.Sample == "2" ~ between(cap_interval_mins, 22.5, 37.5),
      Collection.Sample == "4" ~ between(cap_interval_mins, 592.5, 607.5),
      TRUE ~ NA
    ),

    cap_adequate = case_when(
      Collection.Sample == "2" ~ between(cap_interval_mins, 15, 45),
      Collection.Sample == "4" ~ between(cap_interval_mins, 585, 615),
      TRUE ~ NA
    ),
    
    booklet_good = case_when(
      Collection.Sample == "2" ~ between(booklet_interval_mins, 22.5, 37.5),
      Collection.Sample == "4" ~ between(booklet_interval_mins, 592.5, 607.5),
      TRUE ~ NA
    ),

    booklet_adequate = case_when(
      Collection.Sample == "2" ~ between(booklet_interval_mins, 15, 45),
      Collection.Sample == "4" ~ between(booklet_interval_mins, 585, 615),
      TRUE ~ NA
    )
  )

```


Tracking adherence
```{r}
adherence_summary <- df_q2 %>%
  group_by(Collection.Sample) %>%
  summarise(
    N = n(),

    #cap
    cap_good_n = sum(cap_good == TRUE, na.rm = TRUE),
    cap_adequate_n = sum(cap_adequate == TRUE, na.rm = TRUE),
    cap_missing_n = sum(is.na(cap_interval_mins)),

    #booklet
    booklet_good_n = sum(booklet_good == TRUE, na.rm = TRUE),
    booklet_adequate_n = sum(booklet_adequate == TRUE, na.rm = TRUE),
    booklet_missing_n = sum(is.na(booklet_interval_mins)),

    .groups = "drop"
  ) %>%
  mutate(
    cap_good_pct = round(100 * cap_good_n / (N - cap_missing_n), 1),
    cap_adequate_pct = round(100 * cap_adequate_n / (N - cap_missing_n), 1),

    booklet_good_pct = round(100 * booklet_good_n / (N - booklet_missing_n), 1),
    booklet_adequate_pct = round(100 * booklet_adequate_n / (N - booklet_missing_n), 1)
  )

#Create a tidy table for report/presentation
adherence_table <- adherence_summary %>%
  mutate(Collection.Sample = recode(Collection.Sample,
                                    "2" = "30 min",
                                    "4" = "10 hr")) %>%
  rename(
    `Sample Time` = Collection.Sample,
    `N` = N,
    `Cap Missing (n)` = cap_missing_n,
    `Booklet Missing (n)` = booklet_missing_n,
    `Cap Sample Good Adherence (%)` = cap_good_pct,
    `Cap Sample Adequate Adherence (%)` = cap_adequate_pct,
    `Booklet Sample Good Adherence (%)` = booklet_good_pct,
    `Booklet Sample Adequate Adherence (%)` = booklet_adequate_pct
  ) %>%
  dplyr::select(
    `Sample Time`,
    `N`,
    `Cap Missing (n)`,
    `Cap Sample Good Adherence (%)`,
    `Cap Sample Adequate Adherence (%)`,
    `Booklet Missing (n)`,
    `Booklet Sample Good Adherence (%)`,
    `Booklet Sample Adequate Adherence (%)`
  )

kable(adherence_table, caption = "Cap and Booklet Adherence by Collection Sample")
```

Calculate deviation (minutes) by sample for visualization
```{r}
df_q2 <- df_q2 %>%
  mutate(
    target_mins = case_when(
      Collection.Sample == "2" ~ 30,
      Collection.Sample == "4" ~ 60*10,
      TRUE ~ NA_real_
    ),
    cap_dev_mins = cap_interval_mins - target_mins,
    booklet_dev_mins = booklet_interval_mins - target_mins
  )

```




Cap Adherence Deviation Visualization
```{r}
ggplot(df_q2 %>% filter(!is.na(cap_dev_mins)),
       aes(x = cap_dev_mins)) +
  geom_histogram(binwidth = 10, fill = "steelblue") +
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = c(-7.5, 7.5), linetype = "dashed") +
  geom_vline(xintercept = c(-15, 15), linetype = "dotted") +
  theme_minimal() +
  labs(
    x = "Cap deviation from target (minutes)",
    y = "Count",
    title = "Cap Sampling Deviations"
  )
```
Booklet Adherence Deviation
```{r}
ggplot(df_q2 %>% filter(!is.na(booklet_dev_mins)),
       aes(x = booklet_dev_mins)) +
  geom_histogram(binwidth = 10, fill = "steelblue") +
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = c(-7.5, 7.5), linetype = "dashed") +
  geom_vline(xintercept = c(-15, 15), linetype = "dotted") +
  theme_minimal() +
  labs(
    x = "Booklet deviation from target (minutes)",
    y = "Count",
    title = "Booklet Sampling Deviations"
  )

```


Let's see whether cap deviations vary by sample:
```{r}
ggplot(df_q2 %>% filter(!is.na(cap_dev_mins)),
       aes(factor(Collection.Sample), cap_dev_mins)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
  labs(
    x = "Sample",
    y = "Cap deviation (minutes)",
    title = "Cap Deviations by Sample"
  )

```
Let's see whether bookletdeviations vary by sample:
```{r}
ggplot(df_q2 %>% filter(!is.na(booklet_dev_mins)),
       aes(factor(Collection.Sample), booklet_dev_mins)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
  labs(
    x = "Sample",
    y = "Booklet deviation (minutes)",
    title = "Booklet Deviations by Sample"
  )
```

Visualize cap and booklet times together
```{r}
dfq2_long <- df_q2 %>%
  pivot_longer(
    cols = c(cap_dev_mins, booklet_dev_mins),
    names_to = "method",
    values_to = "dev_mins"
  ) %>%
  filter(!is.na(dev_mins)) %>%  
  mutate(
    method = recode(method,
                    cap_dev_mins = "Cap",
                    booklet_dev_mins = "Booklet"),
    Collection.Sample = factor(Collection.Sample)
  )

ggplot(dfq2_long, aes(Collection.Sample, dev_mins, fill = method)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_minimal(base_size = 14) +
  labs(
    x = "Sample",
    y = "Deviation (minutes)",
    title = "Cap and Booklet Deviations by Sample",
    fill = "Method"
  )

```



Question 3:
What are the patterns of change over the course of the day? What is the investigator interested in knowing about changes over time?
The investigator stated that levels of cortisol and DHEA are expected to increase sharply from waking to 30 minutes after waking and then decline more slowly over the rest of the day.
She was interested in knowing if the SPIT test shows this expected pattern.
She wanted to know: 1) is there an increase in cortisol and/or DHEA from waking to 30 minutes post waking? And 2) what is the rate of decline in cortisol and DHEA after 30 minutes from waking?
She also stated that even if there are not statistically significant differences, she would like to know the estimates for the initial increase and rates of decline so she can compare them to what is known from other more standard hormone tests.


Biological Range of Data
Cortisol > 26 keep but weird, Cortisol > 80 incorrect - probably a laboratory error
DHEA upper limit on assay is 5.205 (max value in dataset - exclude these) - probably an error unless this is recorded repeatedly by the same individual (probably exclude these individuals bc they have a different process going on)

Outliers: Check no cortisol > 80, check no DHEA >5.205

```{r}
#One outlier with cortisol value > 80 - remove this
df_q3 <- filter(df_mod, Cortisol..nmol.L. < 80)

#DHEA 
x <- filter(df_q3,DHEA..nmol.L. == 5.205)

#SubjectID 3037 needs to be be removed as it is at the upper limit multiple times, suggesting something is wrong
df_q3 <- filter(df_q3, SubjectID != 3037)

# Remove DHEA levels that are at the lab maximum
df_q3 <- filter(df_q3,DHEA..nmol.L. < 5.205000)

#Removing large Cortisol outlier
df_q3 <- filter(df_q3, Cortisol..nmol.L. < 30)
```


```{r}
#Visualize cortisol
hist(df_q3$Cortisol..nmol.L., main = "Histogram of Cortisol (nmol/L)", xlab = "Cortisol (nmol/L)")
#Heavy right skew - let's look at a log transformation
hist(log(df_q3$Cortisol..nmol.L.), main = "Histogram of Cortisol (nmol/L)", xlab = "Cortisol (nmol/L)")
```


```{r}
#Visualizing DHEA
hist(df_q3$DHEA..nmol.L., main = "Histogram of DHEA (nmol/L)", xlab = "DHEA (nmol/L)")
#Again heavy right skew - let's look at the log transform
hist(log(df_q3$DHEA..nmol.L.),  main = "Histogram of DHEA (nmol/L)", xlab = "DHEA (nmol/L)")
```

```{r}
summary(df_q3$DHEA..nmol.L.)
summary(df_q3$Cortisol..nmol.L.)
```

Significant outlier of 37, let's remove this
```{r}
ggplot(df_q3, aes(x = cap_interval_mins, y = Cortisol..nmol.L., group = SubjectID, color = factor(SubjectID))) +
  geom_line() +
  theme_minimal(base_size = 14) +
  labs(
    x = "Minutes since waking (Book)",
    y = "Cortisol (nmol/L)",
    title = "Cortisol Over Time Since Waking"
  )
```

Subject 3024 has elevated DHEA levels
```{r}
ggplot(df_q3, aes(x = cap_interval_mins, y = DHEA..nmol.L., group = SubjectID, color = factor(SubjectID))) +
  geom_line() +
  theme_minimal(base_size = 14) +
  labs(
    x = "Minutes since waking (Book)",
    y = "DHEA (nmol/L)",
    title = "DHEA Over Time Since Waking"
  )
```

Let's see if DHEA even needs a changepoint like cortisol
```{r}
ggplot(df_q3, aes(x = cap_interval_mins, y = DHEA..nmol.L., group = SubjectID, color = factor(SubjectID))) +
  geom_line() +
  theme_minimal(base_size = 14) +
  labs(
    x = "Minutes since waking (Book)",
    y = "DHEA (nmol/L)",
    title = "DHEA Over Time Since Waking"
  ) +
  coord_cartesian(xlim = c(0, 120))

```
Changepoint at 30 might make sense let's investigate further

```{r}
dhea_peak_bysubj <- df_q3 %>%
  filter(!is.na(DHEA..nmol.L.), !is.na(booklet_interval_mins)) %>%
  group_by(SubjectID) %>%
  slice_max(DHEA..nmol.L., with_ties = FALSE) %>%
  summarise(
    peak_minute = booklet_interval_mins,
    peak_dhea = DHEA..nmol.L.,
    .groups = "drop"
  )

hist(dhea_peak_bysubj$peak_minute, main = "Histogram of Peak DHEA Timing (Booklet Minutes since Waking)")
```



Create variable for 30 minute knot and let's proceed with logging DHEA and Cortisol

```{r}
#Modified from BIOS 6643 code- changepoint creation
df_q3 <- df_q3 %>%
  mutate(
    wake_30 = pmin(booklet_interval_mins, 30),
    after_30 = pmax(booklet_interval_mins - 30, 0),
    log_cortisol = log(Cortisol..nmol.L.),
    log_dhea = log(DHEA..nmol.L.)
  )
```


Piecewise linear regression (lmm w random slope for subject) for Cortisol

```{r}
q3_cortisol.lmm <- lmer(
  log_cortisol ~ wake_30 + after_30 + (1 | SubjectID),
  data = df_q3
)

summary(q3_cortisol.lmm)
```
```{r}
cortisol_table <- tidy(q3_cortisol.lmm, effects = "fixed", conf.int = TRUE)
cortisol_table <- cortisol_table %>%
  mutate(
    estimate_exp = exp(estimate),
    conf.low_exp = exp(conf.low),
    conf.high_exp = exp(conf.high)
  )

cortisol_table_exp <- cortisol_table %>%
  dplyr::select(term, estimate_exp, conf.low_exp, conf.high_exp, p.value) %>%
  rename(
    Term = term,
    `Rate Ratio` = estimate_exp,
    `95% CI Lower` = conf.low_exp,
    `95% CI Upper` = conf.high_exp,
    `p-value` = p.value
  )
kable(cortisol_table_exp, digits = 3,
      caption = "Linear Mixed Model of Log DHEA on Minutes Since Waking - Raw Estimates")
kable(cortisol_table_exp, digits = 3,
      caption = "Linear Mixed Model of Log DHEA on Minutes Since Waking - Transformed Estimates")
```


Piecewise linear regression (lmm w random slope for subject) for DHEA
```{r}
q3_dhea.lmm <- lmer(
  log_dhea ~ booklet_interval_mins + (1 | SubjectID),
  data = df_q3
)

summary(q3_dhea.lmm)
```
Get results in an easy to read format
```{r}
dhea_table <- tidy(q3_dhea.lmm, effects = "fixed", conf.int = TRUE)
dhea_table <- dhea_table %>%
  mutate(
    estimate_exp = exp(estimate),
    conf.low_exp = exp(conf.low),
    conf.high_exp = exp(conf.high)
  )

dhea_table_exp <- dhea_table %>%
  dplyr::select(term, estimate_exp, conf.low_exp, conf.high_exp, p.value) %>%
  rename(
    Term = term,
    `Rate Ratio` = estimate_exp,
    `95% CI Lower` = conf.low_exp,
    `95% CI Upper` = conf.high_exp,
    `p-value` = p.value
  )

kable(dhea_table, digits = 3,
      caption = "Linear Mixed Model of Log DHEA on Minutes Since Waking - Raw Estimates")
kable(dhea_table_exp, digits = 3,
      caption = "Linear Mixed Model of Log DHEA on Minutes Since Waking - Transformed Estimates")
```

From resource on canvas:
If this is a value great than 1, you can subtract 1 and multiply by 100 to get the % increase associated with a 1-unit increase in X1.

If this value is less than 1, you can subtract 1 and multiple by 100 to get the % decrease associated with a 1-unit increase in X1.

This means that exp(beta1) can be roughly interpreted as the percentage change in of Y with a one unit increase in X1.

Visualizing the fit of Cortisol lmm
```{r}
pred_df <- tibble(
  booklet_interval_mins = seq(min(df_q3$booklet_interval_mins, na.rm = TRUE),
                          max(df_q3$booklet_interval_mins, na.rm = TRUE),
                          length.out = 200)
) %>%
  mutate(
    wake_30 = pmin(booklet_interval_mins, 30),
    after_30 = pmax(booklet_interval_mins - 30, 0)
  )

pred_df$pred_log_cort <- predict(q3_cortisol.lmm, newdata = pred_df, re.form = NA)

# Back-transform to nmol/L
pred_df$pred_cort <- exp(pred_df$pred_log_cort)

ggplot(df_q3,
       aes(x = booklet_interval_mins,
           y = Cortisol..nmol.L.,
           group = SubjectID,
           color = factor(SubjectID))) +
  geom_line() +
  geom_line(
    data = pred_df,
    aes(x = booklet_interval_mins, y = pred_cort),
    inherit.aes = FALSE,
    linewidth = 1,
    color = "black"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none") +
  labs(
    x = "Minutes since waking (cap)",
    y = "Cortisol (nmol/L)",
    title = "Cortisol Over Time Since Waking (with Model Fit)"
  )

```
DHEA
```{r}

pred_dhea <- tibble(
  booklet_interval_mins = seq(min(df_q3$booklet_interval_mins, na.rm = TRUE),
                              max(df_q3$booklet_interval_mins, na.rm = TRUE),
                              length.out = 200)
)

pred_dhea$pred_log_dhea <- predict(q3_dhea.lmm, newdata = pred_dhea, re.form = NA)

# Back-transform to nmol/L
pred_dhea$pred_dhea <- exp(pred_dhea$pred_log_dhea)

ggplot(df_q3,
       aes(x = booklet_interval_mins,
           y = DHEA..nmol.L.,
           group = SubjectID,
           color = factor(SubjectID))) +
  geom_line() +
  geom_line(
    data = pred_dhea,
    aes(x = booklet_interval_mins, y = pred_dhea),
    inherit.aes = FALSE,
    linewidth = 1,
    color = "black"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none") +
  labs(
    x = "Minutes since waking (booklet)",
    y = "DHEA (nmol/L)",
    title = "DHEA Over Time Since Waking (Linear Mixed Model Fit)"
  )

```


